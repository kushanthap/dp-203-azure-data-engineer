{
	"name": "02 serverless sql pool external tables",
	"properties": {
		"folder": {
			"name": "serverless sql pool"
		},
		"content": {
			"query": "-- 1) new database\nCREATE DATABASE Sales\n  COLLATE Latin1_General_100_BIN2_UTF8;\nGO;\n\nUse Sales;\nGO;\n-- 2) scoped creds (if needed)\n    -- if not authenticated with Synapse\n\n-- 3) new data source\n-- DROP EXTERNAL DATA SOURCE sales_data\nCREATE EXTERNAL DATA SOURCE sales_data WITH (\n    LOCATION = 'https://datalake9nlosdj.dfs.core.windows.net/files/dp-203/Allfiles/labs/02/data/'\n);\nGO;\n\nCREATE EXTERNAL DATA SOURCE external_table_data WITH (\n    LOCATION = 'https://datalake9nlosdj.dfs.core.windows.net/files/external_table_data/'\n);\nGO;\n\nCREATE EXTERNAL DATA SOURCE lab_03_data WITH (\n    LOCATION = 'https://datalake9nlosdj.dfs.core.windows.net/files/dp-203/Allfiles/labs/03/data/'\n);\nGO;\n\n-- 4) file format\n\n    -- csv format\nCREATE EXTERNAL FILE FORMAT CsvFormat\n    WITH (\n        FORMAT_TYPE = DELIMITEDTEXT,\n        FORMAT_OPTIONS(\n            FIELD_TERMINATOR = ',',\n            STRING_DELIMITER = '\"'\n        )\n    );\nGO;\n\n    -- parquet format\n-- drop EXTERNAL FILE FORMAT ParquetFormat\nCREATE EXTERNAL FILE FORMAT ParquetFormat\n    WITH (\n            FORMAT_TYPE = PARQUET,\n            DATA_COMPRESSION = 'org.apache.hadoop.io.compress.SnappyCodec'\n        );\nGO;\n\n\n-- 5) external table\n-- DROP EXTERNAL TABLE dbo.orders\n\n    -- exsting csv files\nCREATE EXTERNAL TABLE dbo.orders\n(\n    SalesOrderNumber VARCHAR(10),\n    SalesOrderLineNumber INT,\n    OrderDate DATE,\n    CustomerName VARCHAR(25),\n    EmailAddress VARCHAR(50),\n    Item VARCHAR(30),\n    Quantity INT,\n    UnitPrice DECIMAL(18,2),\n    TaxAmount DECIMAL (18,2)\n)\nWITH\n(\n    DATA_SOURCE =sales_data,\n    LOCATION = '*.csv',\n    FILE_FORMAT = CsvFormat\n);\nGO\n\n    -- existing parquet files\n-- DROP EXTERNAL TABLE dbo.ordersParquet\n-- ********* NOT WORKING *****\nCREATE EXTERNAL TABLE dbo.ordersParquet\n(\n    Product VARCHAR(8),\n    ItemsSold BIGINT,\n    NetRevenue FLOAT\n)\nWITH (\n    DATA_SOURCE =external_table_data,\n    LOCATION = 'productsales/',\n    FILE_FORMAT = ParquetFormat\n);\nGO\n\n\n-- create external table as select (SETAS)\nCREATE EXTERNAL TABLE ProductSalesTotals\n    WITH (\n        LOCATION = 'productsales/',\n        DATA_SOURCE = external_table_data,\n        FILE_FORMAT = ParquetFormat\n    )\nAS\nSELECT Item AS Product,\n    SUM(Quantity) AS ItemsSold,\n    ROUND(SUM(UnitPrice) - SUM(TaxAmount), 2) AS NetRevenue\nFROM\n    OPENROWSET(\n        BULK '*.csv', -- relative path only as DATA_SOURCE is given\n        DATA_SOURCE = 'lab_03_data',\n        FORMAT = 'CSV',\n        PARSER_VERSION = '2.0',\n        HEADER_ROW = TRUE\n    ) AS orders\nGROUP BY Item;\n\n\n-- query external table\nSELECT TOP 100 * FROM [dbo].[orders]\nSELECT TOP 100 * FROM [dbo].[ordersParquet]\nSELECT TOP 100 * FROM [dbo].[ProductSalesTotals]\n\nSELECT YEAR(OrderDate) AS OrderYear,\n        MONTH(OrderDate) AS OrderMonth,\n        SUM(Quantity) Quantity,\n       SUM((UnitPrice * Quantity) + TaxAmount) AS GrossRevenue\nFROM dbo.orders\nGROUP BY YEAR(OrderDate), MONTH(OrderDate)\nORDER BY OrderYear, OrderMonth;\n\n-- **********************\n-- keep things neat in a stored procedure\nUSE Sales;\nGO;\n\nDROP PROCEDURE sp_GetYearlySales\n\nCREATE PROCEDURE sp_GetYearlySales\nAS\nBEGIN\n    -- drop existing table\n    IF EXISTS (\n            SELECT * FROM sys.external_tables\n            WHERE name = 'YearlySalesTotals'\n        )\n        DROP EXTERNAL TABLE YearlySalesTotals\n    -- create external table\n    CREATE EXTERNAL TABLE YearlySalesTotals\n    WITH (\n            LOCATION = 'yearlysales/',\n            DATA_SOURCE = external_table_data,\n            FILE_FORMAT = ParquetFormat\n        )\n    AS\n    SELECT YEAR(OrderDate) AS CalendarYear,\n            SUM(Quantity) AS ItemsSold,\n            ROUND(SUM(UnitPrice) - SUM(TaxAmount), 2) AS NetRevenue\n    FROM\n        OPENROWSET(\n            BULK '*.csv',\n            DATA_SOURCE = 'lab_03_data',\n            FORMAT = 'CSV',\n            PARSER_VERSION = '2.0',\n            HEADER_ROW = TRUE\n        ) AS orders\n    GROUP BY YEAR(OrderDate)\nEND\n\nEXEC sp_GetYearlySales;\n\nSELECT * FROM dbo.YearlySalesTotals\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "Sales",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}